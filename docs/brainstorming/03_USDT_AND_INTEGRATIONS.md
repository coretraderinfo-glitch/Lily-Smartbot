# Lily Bot - USDT Engine & Integrations Blueprint

## 1. The P2P Pricing Engine
The user specifically requested commands like `lk` (List Card), `lz` (List Alipay), `lw` (List WeChat). This implies Lily is an **OTC (Over-The-Counter) Assistant**.

### 1.1 Data Source Strategy
*   **Direct API**: Most exchanges (OKX, Binance, Huobi) have P2P APIs, but they are often private or rate-limited.
*   **Public Endpoint Scraping**:
    *   Target: OKX P2P Public Marketplace.
    *   Mechanism: Headless Browser or specialized API client mimicking a web user.
    *   **Frequency**: Every 30-60 seconds. High frequency is needed for "Arbitrage" or "Accurate Pricing", but 60s is safe for stability.

### 1.2 The "Best Price" Algorithm
We don't just grabbing the first price. Fraudsters often list fake prices.
*   **Filter Logic**:
    *   Min Completion Rate: > 90%
    *   Min Orders: > 100
    *   Merchant Verified: Boolean (Configurable preference).
*   **Calculation**:
    *   `Top3_Avg`: Average of the top 3 valid sell orders.
    *   `Safe_Price`: The price used for `k100` calculations.

### 1.3 Command Implementation Details

#### 1.3.1 Query Commands (`lk`, `lz`, `lw`)
*   **Input**: `lk`
*   **Output**:
    ```text
    üè¶ OKX Real-time Price (Bank Card)
    
    1. MerchantA | 7.25 | Limit: 1k-10k
    2. MerchantB | 7.26 | Limit: 5k-50k
    3. MerchantC | 7.27 | Limit: 10k-100k
    
    Average: 7.26
    Updated: just now
    ```

#### 1.3.2 Calculator Commands (`k100`, `z100`, etc.)
*   **Input**: `k100` (100 CNY via Card -> USDT)
*   **Formula**: `100 / Best_Ask_Price = USDT`.
*   **Output**:
    ```text
    üí≥ Card Payment: 100 CNY
    Rate: 7.25
    ‚âà 13.79 USDT
    ```

---

## 2. Advanced Integrations (World-Class Additions)

### 2.1 TRC20 Wallet Monitoring (The "Flash" Feature)
*   **Concept**: Since users are dealing with USDT, they likely verify on-chain transactions.
*   **Feature**: "Watch Address".
*   **Command**: `ÁõëÊéßÂú∞ÂùÄ T9x...`
*   **Logic**:
    *   Lily polls TronGrid API / TRON Node.
    *   When a transaction hits `T9x...`:
    *   **Alert**: "üö® Incoming Transfer! +1000 USDT (Hash: xy7z...)".
    *   **Auto-Record**: Can optionally auto-add into the Ledger!
    *   *Result*: Automated reconciliation.

### 2.2 OCR Receipt Scanning
*   **Pain Point**: Users manually typing `+1000`.
*   **Feature**: Drop a screenshot of a Bank Receipt.
*   **Tech Stack**: Google Cloud Vision API / Tesseract / GPT-4o-mini Vision.
*   **Workflow**:
    1.  User uploads photo.
    2.  Lily scans.
    3.  Extracts: Amount (1000), Time, Sender.
    4.  Lily asks: "Record +1000 from Zhang San?"
    5.  User clicks "Yes".

### 2.3 Image Generators for Bills
*   **Current**: Text-based bill.
*   **Better**: Python `Pillow` or `Canvas` generated Image Bill.
*   **Why?**: Harder to fake, looks professional, easy to share on WhatsApp/WeChat.
*   **Design**:
    *   Background: Professional dark/light theme gradient.
    *   Header: Group Name + Date.
    *   Body: Transaction Table.
    *   Footer: Net Total + Watermark "Generated by Lily".

---

## 3. Deployment & Security for Finance

### 3.1 Floating Point Danger
*   **Rule**: NEVER use standard floating point math (`0.1 + 0.2 = 0.300000004`).
*   **Tech**: Use `Decimal` library in code and `DECIMAL` in SQL.
*   **Rounding**: Explicit round-half-up strategies defined in config.

### 3.2 Audit Trails
*   Every rate change, operator addition, or cleared data event must be logged to a strictly append-only `audit_logs` table.
*   Admins can query `/audit` to see who changed the rate last night.

